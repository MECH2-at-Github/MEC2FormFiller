<html>
<head>
    <meta charset="utf-8" />
	<!-- meta knowledge: index.html -->
    <script type="text/javascript" src="./pdf-lib.min.js"></script>
    <script type="text/javascript" src="./download.js"></script>
    <!-- <script type="text/javascript" src="https://unpkg.com/pdf-lib"></script> -->
    <!-- <script type="text/javascript" src="https://unpkg.com/downloadjs@1.4.7"></script> -->
	<script type="text/javascript" src="./csReferral.js"></script>
	<script type="text/javascript" src="./csGoodCause.js"></script>
	<script type="text/javascript" src="./ccapBillingForm.js"></script>
	<title>MEC2 AutoForm</title>
</head>

<body>
	<div class="container">
		<div>Click the button to fill PDF form fields and download the resulting file to your computer. </div>
		<div id="buttonDiv">
			<button class="fillButton" id="fillPDFbutton">Fill PDF</button>
			<button class="fillButton" style="display: none" id="fillPDFbuttonMin">Fill PDF (2 pg Good Cause)</button>
		</div>
		<div style="display: none; margin-bottom: 20px;" id="billingForm">
			<div id="periodDiv">
				<button class="directionButton" id="decrementPeriod">«</button>
				<span>Period Start:</span>
				<span id="periodStart" style="width: 9.5ch;"></span>
				<button class="directionButton" id="incrementPeriod">»</button>
			</div>
			<div id="copayDiv" style="line-height: 25px;">
				<span>Copay: $</span>
				<input id="copayAmount" type="number" style="width: 6ch; align-self: end; -webkit-appearance: none; -moz-appearance: textfield;"></input>
			</div>
		</div>
		<div>Default download location is "This PC → Downloads"</div>
	</div>
	<div class="container">
		<div id="dataOutput"></div>
	</div>
</body>

<script type="text/javascript">	
	const { PDFDocument } = PDFLib;
	const fillFormInfo = JSON.parse(new URLSearchParams(decodeURI(window.location.search)).get('parm1'));
	if (fillFormInfo.pdfType === "ChildSupportForms") {
		document.getElementById('fillPDFbuttonMin').style.display = "block"
	} else if (fillFormInfo.pdfType === "BillingForm") {
		const weekInMs = 86400000 * 14
		const dateFormat = '{ year: "2-digit", month: "numeric", day: "numeric" }'
		document.getElementById('periodStart').textContent = fillFormInfo.startDate
		document.getElementById('copayAmount').value = fillFormInfo.copayAmount
		document.getElementById('billingForm').style.display = "block"
		document.getElementById('periodDiv').addEventListener('click', function(event) {
			if (event.target.nodeName !== "BUTTON") { return }
			let newStartDate = getNewStartDate(event.target.id)
			function getNewStartDate(changeDirection) {
				let startDate = Date.parse(document.getElementById('periodStart').textContent)
				switch (changeDirection) {
					case "incrementPeriod":
					return new Date(startDate + weekInMs).toLocaleDateString(undefined, dateFormat)
					break
					case "decrementPeriod":
					return new Date(startDate - weekInMs).toLocaleDateString(undefined, dateFormat)
					break
				}
			}
			document.getElementById('periodStart').textContent = newStartDate
			fillFormInfo.startDate = newStartDate
		})
		document.getElementById('copayAmount').addEventListener('blur', function(event) {
			fillFormInfo.copayAmount = event.target.value
		})
	}
	(function outputDataOnPage() {
		let dataOutput = document.getElementById('dataOutput')
		for (let data in fillFormInfo) {
			let info = fillFormInfo[data]
			if (typeof info === "object") { info = objToString(info) }
			dataOutput.appendChild( createNewEle('div') )
			.append( createNewEle('label', { textContent: data + ":" }), createNewEle('div', { textContent: info.toString() }) )
		}
	})();
	<!-- function objectToString(obj) { return Object.entries(obj).map(e => e.join(": ")).join(", ") } -->
	function objToString(obj) { return JSON.stringify(obj).replace(/["{}\[\]]/g, '').replace(/(:|,)(\S)/g, '$1 $2') }
	
	document.getElementById('fillPDFbutton').focus()

	document.getElementById('buttonDiv').addEventListener('click', function(event) {
		if (event.target.nodeName !== "BUTTON") { return }
		if (fillFormInfo.pdfType === "ChildSupportForms") {
			csReferral(fillFormInfo);
			csGoodCause(fillFormInfo, event.target.id);
		} else if (fillFormInfo.pdfType === "BillingForm") {
			ccapBillingForm(fillFormInfo);
		}
	})
	function createNewEle(nodeName, attribObj={}, dataObj) {
		let newEle = Object.assign(document.createElement(nodeName), attribObj);
		if (dataObj !== undefined) {
			for (const [dataName, dataValue] of Object.entries(dataObj)) { newEle.dataset[dataName] = dataValue }
		}
		return newEle
	};
</script>
<style type="text/css">
	body {
		background-color: rgba(185 185 185 / .50);
		font-family: system-ui;
	}
	.container {
		padding: 2rem 0;
		max-width: 1000px;
	}
	#dataOutput {
		padding-top: 4em;
		border-top: 1px solid black;
		> div {
			display: flex;
			width: 100%;
			align-items: center;
			gap: 1em;
			& label {
				width: 50%;
				text-align: right;
			}
			& div {
				width: 50%;
				padding: .3em;
				text-align: left;
			}
		}
	}
	div, .container, img, button {
		margin: auto;
		text-align: center;
	}
	#buttonDiv, #billingForm > div {
		display: flex;
		align-items: center;
		& button {
			display: flex;
			cursor: pointer;
		}
		& .fillButton {
			background-color: rgba(169 169 169 / .8);
			padding: 1rem 2rem;
			font-size: 1.5rem;
			border-radius: 10px;
		}
		& .directionButton {
			background-color: rgba(169 169 169 / .4);
			padding: 0 .4rem 4px;
			line-height: 20px;
			font-size: 140%;
			margin: 0 3px 5px;
			border: 1px solid;
			border-radius: 4px;
		}
	}
	#billingForm > div {
		justify-content: center;
	}
	#buttonDiv {
		flex-direction: column;
		padding: 3rem 0;
		gap: 4rem;
	}
	.fillButton:focus {
		outline: 2px solid;
		outline-color: lightseagreen !important;
	}
	#billingForm > div {
		display: flex;
		gap: 5px;
	}
	input::-webkit-outer-spin-button, input::-webkit-inner-spin-button {
	  -webkit-appearance: none;
	  margin: 0;
	}
</style>
</html>